{% extends 'base.html' %}
{% load static %}

{% block Title %}Modifier l'ordre des locataires{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="h3">
                <i class="fas fa-sort me-2"></i>Modifier l'ordre d'affichage des locataires
            </h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'contrats:contrats_list' %}">Contrats</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'contrats:contrat_locataires' contrat.id %}">Locataires</a></li>
                    <li class="breadcrumb-item active">Modifier l'ordre</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8 mx-auto">
            <!-- Instructions -->
            <div class="alert alert-info">
                <h6 class="alert-heading">
                    <i class="fas fa-info-circle me-2"></i>Comment ça marche ?
                </h6>
                <p class="mb-0">
                    L'ordre détermine dans quel ordre les locataires apparaissent sur les documents officiels (quittances, courriers...).
                    <strong>Glissez-déposez</strong> les cartes ci-dessous pour réorganiser l'ordre, puis cliquez sur "Enregistrer".
                </p>
            </div>

            <!-- Liste triable -->
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>Locataires du contrat
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" id="ordre-form">
                        {% csrf_token %}
                        
                        <div id="sortable-list">
                            {% for relation in relations %}
                            <div class="card mb-2 sortable-item" data-id="{{ relation.id }}" style="cursor: move;">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <!-- Handle pour drag -->
                                        <div class="me-3 text-muted">
                                            <i class="fas fa-grip-vertical fa-2x"></i>
                                        </div>
                                        
                                        <!-- Badge ordre -->
                                        <div class="me-3">
                                            <span class="badge bg-secondary badge-ordre" style="font-size: 1.2rem;">
                                                {{ forloop.counter }}
                                            </span>
                                        </div>
                                        
                                        <!-- Infos locataire -->
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">
                                                <i class="fas fa-user me-2"></i>
                                                {{ relation.locataire.nom_complet }}
                                                {% if relation.principal %}
                                                <span class="badge bg-warning text-dark ms-2">
                                                    <i class="fas fa-star"></i> Principal
                                                </span>
                                                {% endif %}
                                            </h6>
                                            <small class="text-muted">
                                                <i class="fas fa-briefcase me-1"></i>{{ relation.get_role_display }}
                                                <span class="ms-3">
                                                    <i class="fas fa-envelope me-1"></i>{{ relation.locataire.email }}
                                                </span>
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Boutons -->
                        <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                            <a href="{% url 'contrats:contrat_locataires' contrat.id %}" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>Annuler
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Enregistrer l'ordre
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Prévisualisation -->
            <div class="card mt-3 bg-light">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="fas fa-eye me-2"></i>Aperçu sur les documents
                    </h6>
                    <p class="mb-2">Les noms apparaîtront dans cet ordre sur les quittances :</p>
                    <div id="preview" class="p-3 bg-white border rounded">
                        <!-- Mis à jour dynamiquement par JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .sortable-item {
        transition: all 0.3s ease;
    }
    
    .sortable-item:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transform: scale(1.02);
    }
    
    .sortable-ghost {
        opacity: 0.4;
        background: #f0f0f0;
    }
    
    .sortable-drag {
        opacity: 0.8;
        cursor: grabbing !important;
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- Sortable.js pour le drag & drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const sortableList = document.getElementById('sortable-list');
        const form = document.getElementById('ordre-form');
        const preview = document.getElementById('preview');
        
        // Initialiser Sortable.js
        const sortable = Sortable.create(sortableList, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            dragClass: 'sortable-drag',
            handle: '.sortable-item',
            onEnd: function() {
                updateOrderBadges();
                updatePreview();
            }
        });
        
        // Mettre à jour les badges d'ordre
        function updateOrderBadges() {
            const items = sortableList.querySelectorAll('.sortable-item');
            items.forEach((item, index) => {
                const badge = item.querySelector('.badge-ordre');
                badge.textContent = index + 1;
            });
        }
        
        // Mettre à jour la prévisualisation
        function updatePreview() {
            const items = sortableList.querySelectorAll('.sortable-item');
            const names = Array.from(items).map(item => {
                const nom = item.querySelector('h6').textContent.trim();
                return nom.split('\n')[0].trim();
            });
            
            if (names.length === 1) {
                preview.textContent = names[0];
            } else if (names.length === 2) {
                preview.textContent = `${names[0]} et ${names[1]}`;
            } else {
                const lastIndex = names.length - 1;
                const allButLast = names.slice(0, lastIndex).join(', ');
                preview.textContent = `${allButLast} et ${names[lastIndex]}`;
            }
        }
        
        // Initialiser la prévisualisation
        updatePreview();
        
        // Soumettre le formulaire avec le nouvel ordre
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Récupérer l'ordre des IDs
            const items = sortableList.querySelectorAll('.sortable-item');
            const ordre = Array.from(items).map(item => item.dataset.id);
            
            // Ajouter les IDs au formulaire
            ordre.forEach(id => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'ordre[]';
                input.value = id;
                form.appendChild(input);
            });
            
            // Soumettre
            form.submit();
        });
    });
</script>
{% endblock %}