{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% block Title %}Modification Contrat{% endblock Title %}

{% block content %}
<div class="container">
    <h2 class="my-4">
        <i class="fas fa-edit me-2"></i>Modifier le contrat
    </h2>

    <!-- Alerte avec lien vers gestion des locataires -->
    <div class="alert alert-info mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h6 class="alert-heading mb-2">
                    <i class="fas fa-users me-2"></i>Locataires du contrat
                </h6>
                <p class="mb-0">
                    {% with locataires=object.get_tous_locataires %}
                        {% if locataires.count > 0 %}
                            <strong>{{ locataires.count }}</strong> locataire{{ locataires.count|pluralize }} sur ce contrat :
                            {{ object.get_locataires_display }}
                        {% else %}
                            <span class="text-warning">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                Aucun locataire affecté à ce contrat
                            </span>
                        {% endif %}
                    {% endwith %}
                </p>
            </div>
            <a href="{% url 'contrats:contrat_locataires' object.id %}" class="btn btn-primary">
                <i class="fas fa-users me-2"></i>Gérer les locataires
            </a>
        </div>
    </div>

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- Informations principales -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-home me-2"></i>Informations principales
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-12">
                        {{ form.appartement|as_crispy_field }}
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        {{ form.date_debut|as_crispy_field }}
                    </div>
                    <div class="col-md-6">
                        {{ form.date_fin|as_crispy_field }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Conditions financières -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-euro-sign me-2"></i>Conditions financières
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        {{ form.loyer_mensuel|as_crispy_field }}
                    </div>
                    <div class="col-md-4">
                        {{ form.charges_mensuelles|as_crispy_field }}
                    </div>
                    <div class="col-md-4">
                        {{ form.jour_echeance|as_crispy_field }}
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4">
                        {{ form.depot_garantie|as_crispy_field }}
                    </div>
                    <div class="col-md-4">
                        {{ form.indice_reference|as_crispy_field }}
                    </div>
                    <div class="col-md-4">
                        {{ form.date_revision|as_crispy_field }}
                    </div>
                </div>
            </div>
        </div>

        <!-- État du contrat -->
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>État du contrat
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-check">
                            {{ form.actif }}
                            <label class="form-check-label" for="{{ form.actif.id_for_label }}">
                                {{ form.actif.label }}
                            </label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-check">
                            {{ form.preavis_donne }}
                            <label class="form-check-label" for="{{ form.preavis_donne.id_for_label }}">
                                {{ form.preavis_donne.label }}
                            </label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        {{ form.date_preavis|as_crispy_field }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Documents -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-file-pdf me-2"></i>Documents
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        {{ form.fichier_contrat|as_crispy_field }}
                        {% if object.fichier_contrat %}
                            <small class="text-muted">
                                <i class="fas fa-check-circle text-success me-1"></i>
                                Fichier actuel :
                                <a href="{{ object.fichier_contrat.url }}" target="_blank">
                                    Télécharger
                                </a>
                            </small>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        {{ form.etat_lieux_entree|as_crispy_field }}
                        {% if object.etat_lieux_entree %}
                            <small class="text-muted">
                                <i class="fas fa-check-circle text-success me-1"></i>
                                <a href="{{ object.etat_lieux_entree.url }}" target="_blank">
                                    Télécharger
                                </a>
                            </small>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        {{ form.etat_lieux_sortie|as_crispy_field }}
                        {% if object.etat_lieux_sortie %}
                            <small class="text-muted">
                                <i class="fas fa-check-circle text-success me-1"></i>
                                <a href="{{ object.etat_lieux_sortie.url }}" target="_blank">
                                    Télécharger
                                </a>
                            </small>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes -->
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-sticky-note me-2"></i>Notes
                </h5>
            </div>
            <div class="card-body">
                {{ form.notes|as_crispy_field }}
            </div>
        </div>

        <!-- Boutons -->
        <div class="d-flex justify-content-between">
            <a href="{% url 'contrats:contrats_list' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Retour à la liste
            </a>
            <div>
                <a href="{% url 'contrats:contrat_locataires' object.id %}" class="btn btn-info me-2">
                    <i class="fas fa-users me-2"></i>Gérer les locataires
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-2"></i>Enregistrer les modifications
                </button>
            </div>
        </div>
    </form>
</div>

{{ form.media }}

{% endblock %}

{% block extra_css %}
<style>
    .card {
        border: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .card-header {
        border-bottom: 2px solid rgba(0,0,0,0.1);
    }

    .alert-info {
        background-color: #e7f3ff;
        border-color: #b3d9ff;
    }
</style>
{% endblock %}